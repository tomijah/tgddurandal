define(["durandal/system","knockout"],function(e,t){function n(e){return void 0==e&&(e={}),e.closeOnDeactivate||(e.closeOnDeactivate=v.defaults.closeOnDeactivate),e.beforeActivate||(e.beforeActivate=v.defaults.beforeActivate),e.afterDeactivate||(e.afterDeactivate=v.defaults.afterDeactivate),e.affirmations||(e.affirmations=v.defaults.affirmations),e.interpretResponse||(e.interpretResponse=v.defaults.interpretResponse),e.areSameItem||(e.areSameItem=v.defaults.areSameItem),e}function i(t,n,i){return e.isArray(i)?t[n].apply(t,i):t[n](i)}function a(t,n,i,a,r){if(t&&t.deactivate){e.log("Deactivating",t);var c;try{c=t.deactivate(n)}catch(o){return e.error(o),a.resolve(!1),void 0}c&&c.then?c.then(function(){i.afterDeactivate(t,n,r),a.resolve(!0)},function(t){e.log(t),a.resolve(!1)}):(i.afterDeactivate(t,n,r),a.resolve(!0))}else t&&i.afterDeactivate(t,n,r),a.resolve(!0)}function r(t,n,a,r){if(t)if(t.activate){e.log("Activating",t);var c;try{c=i(t,"activate",r)}catch(o){return e.error(o),a(!1),void 0}c&&c.then?c.then(function(){n(t),a(!0)},function(t){e.log(t),a(!1)}):(n(t),a(!0))}else n(t),a(!0);else a(!0)}function c(t,n,i){return i.lifecycleData=null,e.defer(function(a){if(t&&t.canDeactivate){var r;try{r=t.canDeactivate(n)}catch(c){return e.error(c),a.resolve(!1),void 0}r.then?r.then(function(e){i.lifecycleData=e,a.resolve(i.interpretResponse(e))},function(t){e.error(t),a.resolve(!1)}):(i.lifecycleData=r,a.resolve(i.interpretResponse(r)))}else a.resolve(!0)}).promise()}function o(t,n,a,r){return a.lifecycleData=null,e.defer(function(c){if(t==n())return c.resolve(!0),void 0;if(t&&t.canActivate){var o;try{o=i(t,"canActivate",r)}catch(u){return e.error(u),c.resolve(!1),void 0}o.then?o.then(function(e){a.lifecycleData=e,c.resolve(a.interpretResponse(e))},function(t){e.error(t),c.resolve(!1)}):(a.lifecycleData=o,c.resolve(a.interpretResponse(o)))}else c.resolve(!0)}).promise()}function u(i,u){var v,f=t.observable(null);u=n(u);var s=t.computed({read:function(){return f()},write:function(e){s.viaSetter=!0,s.activateItem(e)}});return s.__activator__=!0,s.settings=u,u.activator=s,s.isActivating=t.observable(!1),s.canDeactivateItem=function(e,t){return c(e,t,u)},s.deactivateItem=function(t,n){return e.defer(function(e){s.canDeactivateItem(t,n).then(function(i){i?a(t,n,u,e,f):(s.notifySubscribers(),e.resolve(!1))})}).promise()},s.canActivateItem=function(e,t){return o(e,f,u,t)},s.activateItem=function(t,n){var i=s.viaSetter;return s.viaSetter=!1,e.defer(function(c){if(s.isActivating())return c.resolve(!1),void 0;s.isActivating(!0);var o=f();return u.areSameItem(o,t,v,n)?(s.isActivating(!1),c.resolve(!0),void 0):(s.canDeactivateItem(o,u.closeOnDeactivate).then(function(l){l?s.canActivateItem(t,n).then(function(l){l?e.defer(function(e){a(o,u.closeOnDeactivate,u,e)}).promise().then(function(){t=u.beforeActivate(t,n),r(t,f,function(e){v=n,s.isActivating(!1),c.resolve(e)},n)}):(i&&s.notifySubscribers(),s.isActivating(!1),c.resolve(!1))}):(i&&s.notifySubscribers(),s.isActivating(!1),c.resolve(!1))}),void 0)}).promise()},s.canActivate=function(){var e;return i?(e=i,i=!1):e=s(),s.canActivateItem(e)},s.activate=function(){var e;return i?(e=i,i=!1):e=s(),s.activateItem(e)},s.canDeactivate=function(e){return s.canDeactivateItem(s(),e)},s.deactivate=function(e){return s.deactivateItem(s(),e)},s.includeIn=function(e){e.canActivate=function(){return s.canActivate()},e.activate=function(){return s.activate()},e.canDeactivate=function(e){return s.canDeactivate(e)},e.deactivate=function(e){return s.deactivate(e)}},u.includeIn?s.includeIn(u.includeIn):i&&s.activate(),s.forItems=function(t){u.closeOnDeactivate=!1,u.determineNextItemToActivate=function(e,t){var n=t-1;return-1==n&&e.length>1?e[1]:n>-1&&n<e.length-1?e[n]:null},u.beforeActivate=function(e){var n=s();if(e){var i=t.indexOf(e);-1==i?t.push(e):e=t()[i]}else e=u.determineNextItemToActivate(t,n?t.indexOf(n):0);return e},u.afterDeactivate=function(e,n){n&&t.remove(e)};var n=s.canDeactivate;s.canDeactivate=function(i){return i?e.defer(function(e){function n(){for(var t=0;t<r.length;t++)if(!r[t])return e.resolve(!1),void 0;e.resolve(!0)}for(var a=t(),r=[],c=0;c<a.length;c++)s.canDeactivateItem(a[c],i).then(function(e){r.push(e),r.length==a.length&&n()})}).promise():n()};var i=s.deactivate;return s.deactivate=function(n){return n?e.defer(function(e){function i(i){s.deactivateItem(i,n).then(function(){r++,t.remove(i),r==c&&e.resolve()})}for(var a=t(),r=0,c=a.length,o=0;c>o;o++)i(a[o])}).promise():i()},s},s}var v,f={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(n){return e.isObject(n)&&(n=n.can||!1),e.isString(n)?-1!==t.utils.arrayIndexOf(this.affirmations,n.toLowerCase()):n},areSameItem:function(e,t){return e==t},beforeActivate:function(e){return e},afterDeactivate:function(e,t,n){t&&n&&n(null)}};return v={defaults:f,create:u,isActivator:function(e){return e&&e.__activator__}}});