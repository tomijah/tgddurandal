define(["durandal/system","jquery"],function(e,t){function n(e,t,n){if(n){var i=e.href.replace(/(javascript:|#).*$/,"");e.replace(i+"#"+t)}else e.hash="#"+t}var i=/^[#\/]|\s+$/g,r=/^\/+|\/+$/g,o=/msie [\w.]+/,a=/\/$/,c={interval:50,active:!1};return"undefined"!=typeof window&&(c.location=window.location,c.history=window.history),c.getHash=function(e){var t=(e||c).location.href.match(/#(.*)$/);return t?t[1]:""},c.getFragment=function(e,t){if(null==e)if(c._hasPushState||!c._wantsHashChange||t){e=c.location.pathname+c.location.search;var n=c.root.replace(a,"");e.indexOf(n)||(e=e.substr(n.length))}else e=c.getHash();return e.replace(i,"")},c.activate=function(n){c.active&&e.error("History has already been activated."),c.active=!0,c.options=e.extend({},{root:"/"},c.options,n),c.root=c.options.root,c._wantsHashChange=c.options.hashChange!==!1,c._wantsPushState=!!c.options.pushState,c._hasPushState=!!(c.options.pushState&&c.history&&c.history.pushState);var a=c.getFragment(),s=document.documentMode,u=o.exec(navigator.userAgent.toLowerCase())&&(!s||7>=s);c.root=("/"+c.root+"/").replace(r,"/"),u&&c._wantsHashChange&&(c.iframe=t('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,c.navigate(a,!1)),c._hasPushState?t(window).on("popstate",c.checkUrl):c._wantsHashChange&&"onhashchange"in window&&!u?t(window).on("hashchange",c.checkUrl):c._wantsHashChange&&(c._checkUrlInterval=setInterval(c.checkUrl,c.interval)),c.fragment=a;var l=c.location,d=l.pathname.replace(/[^\/]$/,"$&/")===c.root;if(c._wantsHashChange&&c._wantsPushState){if(!c._hasPushState&&!d)return c.fragment=c.getFragment(null,!0),c.location.replace(c.root+c.location.search+"#"+c.fragment),!0;c._hasPushState&&d&&l.hash&&(this.fragment=c.getHash().replace(i,""),this.history.replaceState({},document.title,c.root+c.fragment+l.search))}return c.options.silent?void 0:c.loadUrl()},c.deactivate=function(){t(window).off("popstate",c.checkUrl).off("hashchange",c.checkUrl),clearInterval(c._checkUrlInterval),c.active=!1},c.checkUrl=function(){var e=c.getFragment();return e===c.fragment&&c.iframe&&(e=c.getFragment(c.getHash(c.iframe))),e===c.fragment?!1:(c.iframe&&c.navigate(e,!1),c.loadUrl(),void 0)},c.loadUrl=function(e){var t=c.fragment=c.getFragment(e);return c.options.routeHandler?c.options.routeHandler(t):!1},c.navigate=function(t,i){if(!c.active)return!1;if(void 0===i?i={trigger:!0}:e.isBoolean(i)&&(i={trigger:i}),t=c.getFragment(t||""),c.fragment!==t){c.fragment=t;var r=c.root+t;if(""===t&&"/"!==r&&(r=r.slice(0,-1)),c._hasPushState)c.history[i.replace?"replaceState":"pushState"]({},document.title,r);else{if(!c._wantsHashChange)return c.location.assign(r);n(c.location,t,i.replace),c.iframe&&t!==c.getFragment(c.getHash(c.iframe))&&(i.replace||c.iframe.document.open().close(),n(c.iframe.location,t,i.replace))}return i.trigger?c.loadUrl(t):void 0}},c.navigateBack=function(){c.history.back()},c});